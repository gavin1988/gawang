{
    "AWSTemplateFormatVersion":"2010-09-09",
    "Description":"Jenkins Slave CF template.",
    "Parameters":{
        "Environment":{
            "Type":"String",
            "Description":"Environment where the resources will be deployed",
            "AllowedValues":["prod"]
            }
    },
    "Mappings":{
        "RegionMap":{
            "us-west-2":{
                "AMI":"ami-09e4b339",
                "VPCID":"vpc-6c26f009"
            }
        },
        "Environment":{
            "prod":{
                "SN2A": "subnet-bfde73da",
                "SN2B": "subnet-79985b0e",
                "SN2C": "subnet-e404e4bd",
                "env": "prod"
            }
        }
    },
    "Resources":{
        "Ec2Instance2a":{
            "Type":"AWS::EC2::Instance",
            "Properties":{
                "InstanceType":"m3.xlarge",
                "SubnetId": { "Fn::FindInMap":[ "Environment", { "Ref":"Environment" }, "SN2A" ] },
                "SecurityGroupIds": [ { "Ref" : "SourceSG" }, "sg-a1d7b8c4" ],
                "KeyName":"hbogotve",
                "ImageId":{
                    "Fn::FindInMap":[
                        "RegionMap",
                        {
                            "Ref":"AWS::Region"
                        },
                        "AMI"
                    ]
                },
                "IamInstanceProfile":{
                    "Ref":"IAMInstanceProfile"
                },
                "Tags":[
                    {
                        "Key":"Name",
                        "Value": { "Fn::Join" : [ " ", [ { "Ref":"Environment" }, "Jenkins Slave" ] ] }
                    },
                    {
                        "Key":"environment",
                        "Value": { "Ref":"Environment" }
                    },
                    {
                        "Key":"application",
                        "Value":"jenkins-slave"
                    }
                ]
            }
        },
        "Ec2Instance2b":{
            "Type":"AWS::EC2::Instance",
            "Properties":{
                "InstanceType":"m3.xlarge",
                "SubnetId": { "Fn::FindInMap":[ "Environment", { "Ref":"Environment" }, "SN2B" ] },
                "SecurityGroupIds": [ { "Ref" : "SourceSG" }, "sg-a1d7b8c4" ],
                "KeyName":"hbogotve",
                "ImageId":{
                    "Fn::FindInMap":[
                        "RegionMap",
                        {
                            "Ref":"AWS::Region"
                        },
                        "AMI"
                    ]
                },
                "IamInstanceProfile":{
                    "Ref":"IAMInstanceProfile"
                },
                "Tags":[
                    {
                        "Key":"Name",
                        "Value": { "Fn::Join" : [ " ", [ { "Ref":"Environment" }, "Jenkins Slave" ] ] }
                    },
                    {
                        "Key":"environment",
                        "Value": { "Ref":"Environment" }
                    },
                    {
                        "Key":"application",
                        "Value":"jenkins-slave"
                    }
                ]
            }
        },
        "Ec2Instance2c":{
            "Type":"AWS::EC2::Instance",
            "Properties":{
                "InstanceType":"m3.xlarge",
                "SubnetId": { "Fn::FindInMap":[ "Environment", { "Ref":"Environment" }, "SN2C" ] },
                "SecurityGroupIds": [ { "Ref" : "SourceSG" }, "sg-a1d7b8c4" ],
                "KeyName":"hbogotve",
                "ImageId":{
                    "Fn::FindInMap":[
                        "RegionMap",
                        {
                            "Ref":"AWS::Region"
                        },
                        "AMI"
                    ]
                },
                "IamInstanceProfile":{
                    "Ref":"IAMInstanceProfile"
                },
                "Tags":[
                    {
                        "Key":"Name",
                        "Value": { "Fn::Join" : [ " ", [ { "Ref":"Environment" }, "Jenkins Slave" ] ] }
                    },
                    {
                        "Key":"environment",
                        "Value": { "Ref":"Environment" }
                    },
                    {
                        "Key":"application",
                        "Value":"jenkins-slave"
                    }
                ]
            }
        },
        "IAMRole":{
            "Type":"AWS::IAM::Role",
            "Properties":{
                "AssumeRolePolicyDocument":{
                    "Version":"2012-10-17",
                    "Statement":[
                        {
                            "Effect":"Allow",
                            "Principal":{
                                "Service":[
                                    "ec2.amazonaws.com"
                                ]
                            },
                            "Action":[
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
                "Path":"/",
                "Policies": [
                    {
                        "PolicyName": "ec2_describe_only",
                        "PolicyDocument": {
                            "Statement": [
                                {
                                  "Effect": "Allow",
                                  "Action": [
                                    "ec2:Describe*"
                                  ],
                                  "Resource": "*"
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "IAMInstanceProfile":{
            "Type":"AWS::IAM::InstanceProfile",
            "Properties":{
                "Path":"/",
                "Roles":[
                    {
                        "Ref":"IAMRole"
                    }
                ]
            }
        },
        "SourceSG": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "VpcId" : { "Fn::FindInMap":[ "RegionMap", { "Ref":"AWS::Region" }, "VPCID" ]},
                "GroupDescription": "Sample source security group"
            }
        },
        "InboundRule": {
            "Type": "AWS::EC2::SecurityGroupIngress",
            "Properties":{
                "IpProtocol": "tcp",
                "FromPort": "0",
                "ToPort": "65535",
                "SourceSecurityGroupId": {
                    "Fn::GetAtt": [
                      "SourceSG",
                      "GroupId"
                    ]
                },
                "GroupId": {
                    "Fn::GetAtt": [
                        "SourceSG",
                        "GroupId"
                    ]
                }
            }
        }
    }
}
